<%- include('partials/header') %>

<div class="main-container">
    <main class="dashboard-content">
        <header class="dashboard-header">
            <h1 class="page-title">Add New Sale</h1>
            <a href="/sales" class="btn secondary">Back to Sales</a>
        </header>

        <div class="card" style="max-width: 600px; margin: 20px auto;">
            <div class="card-header">Sale Details</div>
            <div class="card-body">
                <form action="/sales/add" method="POST" id="saleForm">
                    <div class="form-group">
                        <label for="product">Select Product</label>
                        <select id="product" name="product" class="form-control" required>
                            <option value="">Select a product...</option>
                            <% products.forEach(product => { %>
                                <option value="<%= product._id %>" 
                                        data-price="<%= product.price %>"
                                        data-stock="<%= product.stock %>">
                                    <%= product.name %> - $<%= product.price %> (Stock: <%= product.stock %>)
                                </option>
                            <% }) %>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="quantity">Quantity</label>
                        <input type="number" id="quantity" name="quantity" class="form-control" 
                               required min="1" onchange="calculateTotal()">
                        <small class="text-muted">Available stock: <span id="availableStock">0</span></small>
                    </div>

                    <div class="form-group">
                        <label for="price">Unit Price ($)</label>
                        <input type="number" id="price" name="price" class="form-control" 
                               required readonly>
                    </div>

                    <div class="form-group">
                        <label for="total">Total Amount ($)</label>
                        <input type="text" id="total" class="form-control" readonly>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn primary">Complete Sale</button>
                        <a href="/sales" class="btn secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </main>
</div>

<script>
document.getElementById('product').addEventListener('change', function() {
    const selected = this.options[this.selectedIndex];
    const price = selected.dataset.price || 0;
    const stock = selected.dataset.stock || 0;
    
    document.getElementById('price').value = price;
    document.getElementById('availableStock').textContent = stock;
    document.getElementById('quantity').max = stock;
    
    calculateTotal();
});

function calculateTotal() {
    const price = parseFloat(document.getElementById('price').value) || 0;
    const quantity = parseInt(document.getElementById('quantity').value) || 0;
    const total = price * quantity;
    
    document.getElementById('total').value = total.toFixed(2);
}

document.getElementById('saleForm').onsubmit = function(e) {
    const quantity = parseInt(document.getElementById('quantity').value);
    const stock = parseInt(document.getElementById('availableStock').textContent);
    
    if (quantity > stock) {
        e.preventDefault();
        alert('Quantity cannot exceed available stock!');
        return false;
    }
    return true;
};
</script>

<link rel="stylesheet" href="/css/dashboard.css">
